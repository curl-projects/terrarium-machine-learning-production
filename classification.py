"""
Goal: generate a web endpoint that runs classification tasks on input data when it's called.

- Implement a functional system which updates a binary flag in the database when the processing is complete that the
frontend listens for and updates the UI in response to.

"""
import os
import modal
from pydantic import BaseModel
from fastapi.responses import HTMLResponse
from typing import Dict

stub = modal.Stub("terrarium-machine-learning")

class ClusterData(BaseModel):
    search_vector: list

@stub.function()
@modal.web_endpoint(method="POST")
def process_clusters(req_json: ClusterData):
    import json
    print("Hello")
    print("DATA:", req_json.search_vector)
    return HTMLResponse("Hi")

pinecone_image = modal.Image.debian_slim().pip_install("requests")

@stub.function(image=pinecone_image, secret=modal.Secret.from_name("terrarium-secrets"))
def load_vectors(search_vector: str, top_k:int=100):
    """
    Loads vectors using search vector from front-end client, and filters by score
    """
    import requests
    import os
    import json

    url = "https://terrarium-1ce80e9.svc.us-west1-gcp.pinecone.io/query"
    data = {
        "vector": search_vector,
        "includeValues": True,
        "topK": top_k
    }
    headers = {
      "Content-Type": "application/json",
      "Api-Key": os.environ['PINECONE_API_KEY']
    }
    
    response = requests.post(url, data=json.dumps(data), headers=headers)
    return response.json()

@stub.function()
def filter_vectors(vector_array):
    filtered_vectors = list(filter(lambda x: x["score"] > 0.25, vector_array))
    return filtered_vectors

machine_learning_image = modal.Image.debian_slim().pip_install("numpy", "scikit-learn", "pandas")
@stub.function(image=machine_learning_image)
def kmeans_classify(vector_matrix, n_clusters:int=50):
    """    
    Needs access to numpy, pandas and sklearn.

    Inputs
    ------
    vector_matrix: numpy matrix of dimension (number_of_vectors * vector dimension)
    token: token for authentication; must match modal secret

    Outputs
    -------
    labels: a dictionary that maps feature requests to a cluster for a specific feature

    """
    import numpy as np
    from sklearn.cluster import KMeans

    print("VECTOR MATRIX:", vector_matrix)

    matrix = np.vstack(vector_matrix['values'].values)
    assert matrix.shape[1] == 2048
    kmeans = KMeans(n_clusters=n_clusters, init="k-means++", random_state=42, n_init=10)
    kmeans.fit(matrix)
    labels = kmeans.labels_
    return labels

database_write_image = (modal.Image.debian_slim()
                             .apt_install("curl")
                             .pip_install("prisma")
                             .run_commands(
                                "curl --create-dirs -o $HOME/.postgresql/root.crt 'https://cockroachlabs.cloud/clusters/af6dfdf3-ae27-4681-bf85-18222dd35911/cert'",
                             ))

@stub.function(mounts=[modal.Mount.from_local_dir("./prisma", remote_path="/root/prisma")], image=database_write_image)
def write_vectors():
    import subprocess

    subprocess.run('prisma generate', shell=True)

    from prisma import Prisma

    return "Done!"

## TESTING FUNCTIONS ##

@stub.local_entrypoint()
def test_load_vectors(): 
    import json
    search_vector = [-0.014830724, -0.014961145, -0.015017039, 0.0062136264, -0.017699985, 0.026885346, -0.010675886, -0.03376039, -0.0045018513, -0.035437234, -0.033313233, 0.015697092, 0.027444292, -0.026307767, -0.008985071, -0.0057711266, 0.009217965, 0.032251235, 0.038902704, 0.0121105155, 0.034747865, 0.0026782872, -0.0024081294, -0.02992229, 0.003616852, -0.027742397, 0.03566081, 0.004802285, 0.018892404, -0.025208505, 0.019619035, -0.00494668, -0.0073827566, 0.0018806234, -0.013219094, -0.0047883117, 0.027816923, 0.025152609, 0.0431507, 0.06383173, -0.007899783, 0.04553554, 0.06521047, -0.019544508, -0.00020931396, -0.030891132, -0.0021449586, -0.0069402573, 0.010508201, -0.012734673, 0.013219094, -0.0037286414, -0.024295557, 0.018203037, 0.015035671, 0.01287441, 0.006861073, -0.02287956, -0.0055708373, 0.024221031, 0.0122782, 0.0043155355, 0.011644727, -0.006004021, 0.017914247, 0.019544508, 0.0041967593, -0.016749775, -0.029251553, 0.0025385504, 0.015156777, 0.00545439, -0.005235469, 0.0039498913, -0.003828786, 0.050826903, -0.02587924, 0.04110123, 0.020792823, -0.0298105, -0.016814984, 0.0024989583, -0.042479962, 0.0068703885, 0.013526514, -0.011588832, 0.003924273, 0.030313553, 0.02194798, -0.030965658, -0.010936728, -0.019507246, 0.03912628, 0.010154202, 0.012464516, 0.009110834, 0.025953766, -0.0012017358, 0.017150354, -0.057198897, 0.023457138, 0.026438188, 0.0106199905, -0.004390062, 0.0076994933, 0.0058549684, 0.02289819, 0.048702903, 0.0012634528, 0.0013100317, 0.027257977, -0.008570519, -0.007084652, -0.007489888, 0.017606826, -0.008384204, 0.009506755, -0.0024034716, -0.019730825, 0.0022707216, -0.036201127, 0.0153617235, 0.0016325907, 0.005500969, 0.00044308184, 0.0026154057, 0.0059853895, -0.042852595, 0.0063719945, 0.04915006, 0.014812092, -0.029177027, -0.013833935, -0.007969651, 0.010023781, -0.014523303, -0.0067865467, 0.02681082, 0.00087684795, 0.010675886, 0.009259887, -0.011234832, 0.008584493, -0.010480254, 0.035250917, 0.028729869, -0.016768407, -0.0118683055, 0.008836019, -0.020215245, -0.0049094167, 0.03590302, 0.017988773, 0.026382294, 0.009660466, -0.0030858526, 0.015725039, 0.006856415, 0.023792505, -0.031729553, 0.017513668, 0.017392565, 0.032847445, -0.011588832, -0.014383567, 0.02015935, 0.022227455, -0.01896693, -0.016535511, -0.024370084, 0.02587924, 0.0053146533, 0.012324778, 0.013936409, 0.03038808, -0.0007918414, -0.0029274842, 0.0024104584, 0.02776103, -0.0115702, -0.0021659192, 0.015287197, 0.046206277, -0.017504353, 0.013973672, -0.018538404, -0.035828494, 0.032363024, 0.013023462, -0.051795743, 0.028189555, -0.012306147, 0.028711239, 0.00031440763, 0.030909762, 0.002890221, -0.023699347, -0.011998726, 0.008183914, -0.01852909, -0.007624967, -0.004993259, 0.005412469, 0.0038520757, -0.010899465, 0.0022206493, 0.02289819, -0.0350646, -0.026494082, -0.022097033, -0.017495038, 0.026512714, 0.019320931, 0.024929032, -0.01614425, 0.008794097, -0.016302617, -0.0038963256, 0.010946043, 0.005119022, -0.011039201, 0.01508225, -0.014336987, -0.026400924, -0.016721828, 0.0028785765, 0.01662867, 0.0075504407, -0.007075336, -0.0044669174, -0.037132703, 0.016656617, 0.023885664, -0.018193722, -0.00995857, 0.0075131776, 0.045833644, 0.0030043395, 0.04445491, -0.029288817, 0.019619035, -0.009217965, 0.027407028, 0.020923246, -0.0298105, 0.0027039056, 0.009464834, -0.011495674, 0.0008529762, -0.013694199, -0.01616288, 0.0042712856, 0.010042412, 0.0096138865, -0.0060273106, -0.004646246, 0.019749457, 0.020494718, -0.0066281785, -0.017234195, 0.01269741, -0.007075336, 0.008668334, 0.02276777, 0.012594936, 0.018184405, 0.004643917, -0.0123713575, -0.0034398523, -0.02932608, 0.0036471284, 0.027481554, -0.022246085, 0.0024896425, 0.002687603, -0.0038404309, -0.013442673, 0.0028739185, 0.029009342, -0.018808562, -0.012194358, -0.023717979, -0.0011883443, 0.00960457, 0.03853007, 0.019358194, -0.01830551, 0.02848766, 0.02170577, -0.008169941, 0.020923246, -0.0136103565, -0.010936728, -0.006288152, 0.035101864, -0.010899465, 0.021146823, 0.051423114, 0.0006043613, -0.010042412, -0.005496311, 0.017429827, 0.020289771, -0.011001938, 0.0017373932, -0.011486358, 0.042778067, 0.0015499131, 0.032456182, -0.01640509, 0.028543554, 0.0066188625, -0.051944796, 0.002682945, -0.018929668, 0.011039201, -0.028580816, 0.0021659192, -0.014262461, -0.020327035, -0.00421772, -0.031822708, 0.014020251, -0.007364125, 0.020923246, -0.015538723, -0.015864776, -0.0005158614, 0.037859336, -0.039312597, 0.03433797, 0.0014404526, -0.02707166, -0.03946165, 0.028115029, -0.018445248, 0.023233559, 0.01448604, 0.021612613, -0.03359271, 0.01907872, 0.004518154, -0.0069728624, 0.0038241283, 0.0315805, -0.00035545527, -0.04221912, 0.017318038, -0.038977228, 0.0059900475, 0.002360386, 0.01353583, 0.0061530736, 0.008430782, 0.011169622, -0.040281437, 0.0249104, -0.0012215318, 0.011635411, 0.0021892085, -0.02755608, -0.001808426, -0.0004934453, 0.02599103, 0.03362997, 0.0021659192, 0.020196615, -0.004676522, 0.011085779, -0.013573093, 0.0027877477, -0.02038293, 0.003705352, 0.004008115, 0.02742566, -0.033425022, -0.011290727, -0.02051335, -0.01585546, 0.028413134, -0.004820917, 0.03323871, 0.02979187, 0.01614425, -0.03469197, 0.010983306, 0.04110123, 0.02586061, 0.0071684937, 0.009278518, 0.0043248516, -0.01969356, 0.008901229, 0.031543236, 0.0024081294, -0.0017350643, 0.0052261534, -0.0044995225, -0.01252041, 0.05734795, -0.020177983, 0.015575986, 0.0003190655, 0.025096714, -0.03444976, 0.012725357, 0.0042712856, 0.0008669499, 0.09457381, -0.0015138144, -0.023252191, -0.0050072325, -0.0069169677, -0.003707681, -0.03053713, 0.020569244, 0.02431419, 0.036387444, -0.020476088, -0.009101518, 0.012548357, -0.00010611257, 0.020289771, 0.008738203, -0.019376826, -0.0042014173, -0.011486358, 0.009422913, 0.012306147, 0.0068470994, -0.015510776, -0.029121133, 0.0098747285, 0.013638304, -0.00861244, 0.0058922316, 0.011458411, 0.023103138, 0.004268957, -3.720854e-05, -0.018920353, 0.035269547, -0.019320931, 0.025357557, 0.014253145, -0.0033723128, -0.021053666, 0.009585939, -0.03744944, 0.019600404, -0.009548676, -0.0076855198, -0.0231404, 0.0171783, 0.003973181, -0.02563703, -0.037617125, -0.020736929, 0.004185115, -0.004601996, 0.006125126, 0.00945086, -0.004077983, 0.0009996998, 0.033089656, -0.008505308, 0.007592362, -0.017522985, 0.0113652535, 0.013666252, 0.019768087, 0.023326717, 0.08898434, -0.0024803267, -0.004886127, 0.018184405, 0.027723765, -0.0040034573, -0.021966612, 0.0042806016, -0.019320931, 0.014560566, 0.013675567, 0.024351452, -0.006777231, 0.011728569, 0.017215563, 0.0005411887, -0.0022485966, 0.0035889049, -0.0106199905, -0.017234195, -0.0003638977, -0.054329637, 0.030350816, 0.007368783, 0.019227773, 0.001278591, -0.042405438, -0.009432228, -0.012576304, 0.018286878, 0.020811455, 0.009707044, -0.035586286, -0.028878922, -0.005459048, -0.020047562, -0.015911354, 0.033536814, -0.010480254, -0.022972716, 0.020364298, -0.00061134814, -0.016600722, -0.01812851, 0.021985244, 0.0028436421, -0.020941876, 0.0053472584, -0.007760046, -0.0063254153, 0.038045652, -0.009413597, 0.016610038, 0.003241892, 0.025003558, 0.044082277, -0.0026945898, -0.0067166784, 0.008030203, 0.013927093, 0.0036611021, 0.0052261534, 0.019190509, 0.0072663096, 0.0033001155, 0.014038882, 0.004983943, 0.020196615, 0.014411514, -0.025487978, 0.022730507, -0.01466304, 0.008584493, -0.0004521065, -0.088090025, -0.005850311, -0.023662085, 0.026997134, -0.009357702, 0.0010218248, -0.0054217847, -0.0017152682, 0.015445566, -0.039424386, 0.010088991, -0.038716387, -0.0010206603, -0.00035137963, 0.014001619, -0.005202864, 0.033965338, -0.005920179, -0.02552524, 0.016423723, 0.049187325, 0.0386046, -0.010415044, 0.00082502887, -0.010051728, -0.0026177345, -0.023755243, 0.016768407, 0.07195509, 0.017299406, 0.016106986, 0.012054621, -0.019153247, -0.00050712784, -0.033443656, -0.023196295, -0.009394965, 0.027202081, -0.008295704, 0.027407028, 0.00053303735, -0.1399603, -0.008719571, 0.013498567, 0.06998015, -0.0047883117, 0.011793779, 0.010172833, 0.010852885, 0.00022750885, 0.023196295, 0.012548357, -0.03325734, 0.011700622, 0.016209459, -0.03590302, -0.0070473887, 0.009632518, 0.019973036, -0.01782109, 0.00093041366, -0.0013356501, 0.02586061, 0.01688951, -0.04601996, 0.010470938, 0.0022998336, 0.0070893094, -0.05377069, 0.005524258, 0.011980095, -0.035865758, -0.0021961955, 0.023885664, -0.017327353, -0.000874519, -0.015892724, 0.020792823, -0.0037402862, -0.0138618825, -0.013824619, -0.0016046433, -0.004993259, 0.027835555, -0.023438506, -0.009390308, -0.012203674, 0.011905569, 0.001660538, 0.011989411, 0.017495038, -0.00042415917, -0.032940604, 0.04043049, -0.0071917833, -0.034654707, -0.011793779, 0.016991986, 0.008849992, -0.023885664, 0.0051888903, -0.00837023, 0.0040803123, 0.005198206, -0.03133829, 0.00936236, 0.02848766, -0.016572775, 0.0022800374, 0.018091246, 0.016656617, 0.00078543683, -0.0034049181, -0.028729869, 0.030909762, 0.02457503, -0.018668827, 0.0057664686, 0.019153247, -0.01799809, -0.011775147, -0.0012867423, -0.0050864164, 0.0045018513, -0.025450714, 0.010433675, -0.015054302, -0.0029041949, -0.05496311, 0.027127555, 0.025786083, -0.013219094, 0.016833616, -0.043448806, 0.026661767, 0.0014742224, 0.017122407, 0.006260205, 0.0023988136, -0.020718297, 0.026866714, 0.05321174, -0.0153710395, -0.00020814949, -0.010862201, -0.00441568, 0.028897554, -0.014215882, 0.017168986, -0.028748501, 0.0136289885, -0.013694199, 0.03411439, 0.002731853, 0.031151973, -0.017541617, -0.0018584983, -0.03767302, 0.0004724848, 0.031822708, 0.042479962, 0.018622248, 0.008430782, 0.0041897725, -0.043672383, 0.023736611, 0.018706089, 0.0007324533, -0.041213017, 0.019153247, 0.023978822, 0.025301661, -0.00034148162, 0.008216519, -0.0047114566, 0.02360619, -0.00025560174, 0.006176363, 0.0011114891, 0.021053666, -0.0041199042, -0.019954404, -0.011477043, -0.0086170975, -0.0047394037, -0.0357726, 0.015948618, 0.01614425, 0.03361134, 0.028823027, -0.006902994, 
    0.020587876, -0.010433675, 0.010713149, 0.0136289885, -0.019712193, 0.028599449, -0.0065862574, 0.015510776, -0.029959552, 0.019414088, 0.039983332, 0.009292492, -0.007829914, 0.018035352, 0.010349833, -0.017830405, -0.030835235, 0.014392883, 0.0038497467, 0.014793461, 0.02884166, 0.02802187, -0.00042386804, -0.01519404, -0.038381018, -0.007857862, 0.006390626, -0.07638941, -0.00775073, -0.025897872, -0.008803413, -0.008221177, -0.012157095, -0.01989851, -0.038082913, 0.018631563, 0.035940286, 0.013656936, 0.0065257046, 0.037095442, -0.04601996, 0.008118703, 0.027164819, -0.009557991, -0.02789145, 0.012203674, -0.031897236, -0.0031394183, -0.016013829, 0.002005222, -0.02051335, 0.0049653114, 0.01364762, 0.01329362, 0.018808562, -0.25756273, -0.011206885, 0.0012692752, 0.016377144, 0.020457456, -0.051348586, -0.012492463, 0.033443656, -0.013489251, 0.016982669, -0.015929986, 0.026028292, 0.012725357, -0.011113727, 0.01843593, 0.00021615524, 0.0070101256, -0.011467727, -0.0118776215, -0.03279155, 0.014215882, -0.014961145, -0.00010880541, -0.0180633, 0.021873455, -0.009259887, 0.015864776, 0.014933198, -0.018193722, 0.0077041513, 0.00039562958, -0.0131166205, -0.00018311333, 0.039089017, -0.0069682044, -0.03254934, -0.014020251, -0.020457456, 0.0046625487, -0.0002828213, -0.0077274404, -0.03934986, -0.022842295, -0.0059015476, 0.014644409, -0.0138618825, 0.011831042, -0.029847763, 0.001998235, 0.011663359, 0.035698075, -0.024519136, 0.00048791405, -0.038716387, 0.027257977, -0.023382612, -0.0031184577, -0.0014718934, -0.030015448, 0.013386778, -0.0025641688, -0.004138536, -0.01727146, -0.026046924, -0.029512396, -0.011039201, 0.012203674, 0.0070473887, 0.008468045, 0.0076435986, 0.0008698611, 0.009460176, 0.018566351, -0.015017039, 0.03409576, -0.03979702, 0.015883407, 0.0009793215, -0.025152609, 0.039312597, 0.017811773, -0.015063618, 0.0006008679, -0.0242024, 0.0252644, -0.065992996, 0.020830087, 0.0010870353, -0.03126376, -0.005142311, -0.0005318729, 0.0069402573, -0.015641198, -0.052056585, 0.006064574, 0.01662867, -0.019134615, -0.0026549976, -0.0009129466, 0.026028292, 0.0189483, -0.021612613, 0.013582409, 0.018258931, 0.01143978, 0.0008925683, -0.0017315708, 0.0014392883, -0.0117472, 0.029885026, 0.036387444, 0.027146187, 0.010079675, -0.046094485, -0.0047487197, 0.0027225371, 0.011104411, 0.03253071, 0.024183769, 0.00225209, -0.010247359, -0.012948936, -0.0013880514, 0.022469664, -0.0026922608, 0.059062053, -0.001938847, -0.04259175, 0.013172515, -0.012436568, 0.005244785, -0.0315805, -0.0028296686, -0.0031044842, -0.021407666, -0.0012599594, -0.012222305, -0.0019435049, 0.015035671, 0.014569882, -0.033890814, -0.0153710395, 0.0022963402, 0.010564096, -0.011113727, -0.0073175463, -0.012250252, 0.0065350207, -0.013526514, -0.0032698393, -0.009725676, 0.015184724, -0.017746564, -0.012483147, 0.0171783, -0.029139765, 0.026251871, -0.00945086, -0.005622074, -0.015007724, -0.04221912, 0.01680567, 0.010051728, -0.011374569, -0.05231743, -0.030481236, 0.02660587, -0.016004512, 0.013377462, 0.028692607, -0.005524258, 0.01364762, -0.02956829, -0.034896918, 0.028394502, -0.022097033, 0.022171559, -0.0141040925, -0.01353583, -0.010442991, 0.019320931, -0.046914276, 0.004122233, 0.022022506, -0.007657572, -0.014355619, -0.0021880441, 0.0039312597, 0.012306147, 0.008025546, 0.010946043, 0.008961782, -0.010088991, -0.00044017067, -0.036909126, 0.01567846, 0.0014893606, -0.044939328, 0.009348387, -0.0039871545, -0.020289771, 0.046914276, -0.0064651524, -0.0021111888, 0.03627565, 0.006600231, 0.028673975, -0.037766177, 0.0101262545, 0.016116302, 0.006856415, 0.016675249, -0.0025315636, 0.03316418, -0.006511731, 0.03126376, 0.012688094, 0.016079038, -0.005743179, 0.018463878, -0.028543554, 0.007918414, 0.0343566, -5.385686e-05, -0.008337624, 0.0121012, 0.011402517, 0.014411514, -0.019115983, -0.029493764, -0.0030392737, -0.0067446255, 0.014523303, 0.041399334, -0.043001648, 0.011598147, -0.028767133, -0.018575668, -0.011057832, 0.019134615, -0.022693243, -0.01252041, 0.03387218, -0.02219019, 0.0021496166, 0.017299406, -0.012063937, 0.015697092, -0.0033443654, 0.020718297, -0.0036750757, -0.012473831, -0.0371886, 0.017923564, 0.012259568, -0.015268565, 0.06044079, 0.010852885, 0.027164819, 0.0027388397, 0.0038404309, 0.03661102, 3.180466e-05, 0.044902068, -0.007028757, -0.007019441, 0.010098307, -0.024146505, -0.019395458, 0.00043987954, 0.015520092, 0.035232283, -0.018314825, 0.01048957, -0.01181241, -0.0021111888, -0.022227455, 0.005910863, 0.014271777, -0.034170285, 0.034487024, 0.03377902, -0.004476233, -0.0010934399, 0.03197176, -0.058689423, 0.000618335, 0.11894389, 0.004082641, 0.035623547, -0.018007405, -0.003160379, 0.007951019, -0.028170923, -0.020885982, 0.0052867057, -0.01472825, -0.0022579124, 0.011942832, 0.013181831, -0.027090292, -0.021389034, -0.05045427, 0.028301343, 0.05827953, -0.008151309, -0.008537914, 0.021687139, 0.014597829, -0.042032804, 0.0034538258, 0.0005205193, -0.032828815, 0.037710283, 0.010275307, 0.054925848, -0.023867032, 0.0040034573, -0.034747865, 0.00089839066, 0.012837146, -0.03668555, 0.007853203, 0.023978822, -0.00030188955, 0.025674293, -0.0051376536, 0.0055475477, 0.019153247, -0.038790915, 0.02563703, -0.0024803267, 0.014299724, 0.025208505, 0.004383075, 0.040206913, 0.0029624184, -0.02228335, 0.0022171559, -0.008542571, 0.024612295, 0.03957344, -0.02815229, 0.00912015, -0.015473513, -0.013554462, 0.0040616808, -0.0004358039, 0.007145204, 0.0013577752, 0.069942884, 0.029027974, 0.024109242, 0.02360619, 0.023233559, -0.016731143, -0.0068703885, -0.0057618106, 0.01969356, 0.019619035, 0.010983306, -0.008682308, 0.0034025891, -0.017522985, -0.042256385, -0.02362482, -0.016591407, -0.0030881816, -0.0016500577, -0.00062939746, 0.0053519164, -0.010210096, -0.007722783, 6.284513e-05, -0.009800202, 0.0033140893, 0.008048835, 0.0027854186, 0.006045942, 0.021668507, 0.015268565, -0.0498208, -0.024519136, 0.0012320121, 0.026866714, 0.018491825, 0.007499204, -0.02097914, 0.0026643134, 0.025823345, 0.024463242, 0.037784807, -0.012082568, -0.007583046, -0.0055102846, -0.02159398, -0.041585647, -0.048479326, -0.011709937, 0.036797337, 0.020345666, -0.011085779, 0.016395776, -0.0018515115, -0.0043155355, -0.017616142, -0.026661767, 0.024984926, -0.009101518, 0.00891986, 0.009697729, 0.001170295, -0.018296195, 0.023233559, -0.011244148, -0.0056081004, 0.04065407, 0.018752668, -0.003877694, 0.016982669, 0.0019481628, -0.0123713575, -0.027239345, 0.02300998, -0.0063161, -0.026140083, -0.03469197, 0.005412469, 0.016973354, 0.041175753, -0.020736929, -0.026400924, 0.013396094, -0.032959234, 0.0662911, -0.0010433675, -0.014271777, 0.004077983, -0.012082568, 0.010852885, 0.004951338, 0.0016442355, -0.024649557, 0.0047580353, -0.0121012, 0.008263098, 0.012566989, 0.0058922316, -0.028469028, 0.007075336, -0.015976565, 0.024630927, -0.0238484, 0.012147779, -0.0249104, 0.004427325, -0.022451034, 0.009483465, 0.023904296, -0.013451988, -0.0036308258, -0.014057514, -0.011281411, 0.0031859973, -0.017476406, 0.01430904, 0.018547721, -0.032717023, 0.012790568, -0.0020261824, -0.045237433, 0.019619035, -0.005486995, -0.022972716, 0.0014194922, 0.008495993, -0.0019423404, 0.0028715895, -0.02360619, -0.025413452, 0.021444928, 0.010321885, -0.011123043, 0.0032279182, -0.0034235497, 0.019525878, -0.02062514, 0.010955359, -0.00965115, 0.018268248, 0.0021437942, -0.00027801786, 0.028804395, 0.01066657, -0.003751931, -0.0364806, 0.012194358, 0.009148098, -0.00075748947, -0.0017012946, 0.01143978, -0.016610038, -0.025953766, -0.022115665, -0.022171559, -0.012063937, 0.02504082, 0.009902676, 0.025562504, 0.024407348, 0.02574882, 0.026084188, -0.014644409, -0.013079357, -0.0052960217, 0.026903976, -0.0015673802, -0.021500824, -0.014709619, -0.0024640241, -0.019823983, 0.0042316937, -0.023308085, -0.017560247, 0.012492463, 0.008463387, -0.012483147, 0.0069728624, 0.05425511, -0.048069432, 0.010508201, -0.009273861, -0.028450396, -0.019805351, 0.0014346304, 0.035865758, 0.017308721, -0.013377462, -0.009516071, 0.025823345, 0.023196295, -0.007401388, 0.031878605, -0.0034375233, 0.046802487, -0.02457503, -0.01234341, -0.011188254, -0.015883407, 0.00808144, -0.0044133514, 0.022078402, -0.008770809, 0.012417937, 0.03184134, -0.053472586, 0.0016593735, -0.03327597, 0.0017991103, -0.023680717, 0.043821435, 0.008486677, -0.01978672, 0.013833935, -0.010014465, -0.023922926, -0.01448604, -0.0038357729, 0.028729869, -0.02634503, 0.00861244, -0.014085461, 0.031822708, 0.035977546, -0.01609767, 0.008603124, 0.0016523867, 0.011216201, 0.004203746, 0.0072523355, -0.0062276, 0.0010113445, -0.018640878, 0.009809517, -0.017262142, -0.031543236, -0.004979285, -0.019041456, -0.017075827, 0.019115983, -0.026084188, -0.006902994, 0.014513987, 0.0037123389, 0.0242024, 0.019935772, -0.001256466, -0.0015021698, -0.0123620415, 0.04128754, -0.0011266273, 0.03625702, -0.006474468, 0.01989851, -0.033685867, 0.0032186024, -0.004560075, -0.0020063864, 0.003707681, -0.008430782, 0.019320931, -0.007233704, 0.00984678, -0.011290727, 0.010079675, 0.01722488, -0.015464197, 0.0075085196, -0.017029248, 0.03288471, -0.023270821, 0.016619354, 0.012287515, 0.0073874146, 0.043225225, 0.009641834, -0.02802187, -0.0049746274, 0.005845653, 0.024053348, 0.013507883, 0.009753623, -0.01883651, 0.005412469, -0.056714475, -0.023922926, -0.0012424923, -0.0010835418, -0.00476968, -0.01795151, 0.010461623, 0.0010858708, 0.03256797, 0.0039102994, 0.009022335, 0.014700303, 0.016134933, 0.011765832, -0.012911673, 0.011272095, -0.014206567, -0.013591725, 0.0141227245, 0.031524602, 0.012995515, -0.023252191, 0.030220395, 0.005533574, 0.023922926, 0.008794097, -0.04765954, -0.0021170112, -0.0008780124, 0.028953448, -0.031189237, 0.01967493, 0.01556667, -0.040206913, 0.03573534, -0.016973354, -0.002298669, 0.027947344, 0.017988773, 0.0073501514, -0.013461304, -0.012483147, 0.031524602, -0.003973181, -0.008794097, -0.0007114928, 0.030481236, 0.00011295385, -0.015929986, 
    0.017942196, 0.0028040502, -0.023047242, 0.0064139157, 0.0106106745, -0.021612613, -0.023252191, -0.010182149, 0.027257977, 0.024593662, 0.0027388397, -0.009329755, -0.033555444, 0.018920353, -0.02777966, 0.027686503, 0.023308085, -0.003109142, -0.0136103565, 0.012902357, 0.011178938, -0.008565861, -0.023196295, -0.004890785, 0.05570837, 0.039312597, -0.012893042, 0.021500824, -0.018538404, 0.011020569, 0.018212352, -0.005146969, 0.008146651, 0.015156777, -0.007494546, -0.031207867, 0.026848081, -0.0057338635, 0.026643135, -0.017485721, 0.033555444, -0.030481236, 0.010741096, 0.01616288, 0.0417347, -0.024668189, 0.038679123, 0.018324142, 0.0070893094, -0.0055056266, 0.020010298, 0.028692607, -0.009669781, -0.021892086, -0.0037891942, 0.025897872, -0.023885664, -0.0484048, 0.01852909, -0.005622074, 0.00074584474, 0.006437205, -0.01848251, -5.6331366e-05, -0.0073035727, 0.021538086, -0.00947415, -0.03623839, -0.008076782, 0.046467118, 0.033704497, -0.006944915, -0.0028366554, 0.045982696, -0.0030113263, 0.017793143, 0.049522694, 0.036890496, 0.0118776215, 0.029381974, -0.010675886, -0.010927412, 0.011514306, -0.015585302, 0.022600086, -0.011644727, -0.015426934, -0.011840358, -0.021892086, -0.008659019, 0.030835235, -0.03195313, 0.020774193, 0.024370084, -0.033685867, -0.020830087, -0.012566989, 0.00070567045, -0.030350816, -0.010005149, -0.045982696, 0.014458093, 0.011998726, 0.005626732, 0.030015448, 0.024854505, 0.03314555, 0.023419874, 0.010685201, -0.0055196006, 0.006194995, -0.022991348, 0.010992622, -0.018761983, 0.003968523, -0.014793461, 0.023662085, 0.01090878, 0.019414088, -0.021165455, -0.0064884415, -0.020587876, -0.018100563, 0.0037845362, -0.015287197, 0.01430904, -0.03573534, -0.060329, -0.022208823, -0.013414725, 0.016060406, -0.03323871, 0.016973354, -0.015091565, -0.013824619, 0.012930305, -0.0007918414, 0.04043049, 0.007848546, 0.016218776, 0.015752986, 0.089282446, 0.010629307, 0.033089656, -0.034487024, -0.0037356282, -0.0536589, 0.03221397, 0.037244495, 0.019414088, -0.020569244, 0.02468682, -0.01956314, -0.004343483, 0.0038613915, -0.006255547, 0.04687701, -0.0020599521, 0.006865731, -0.03623839, 0.013396094, 0.02362482, -0.004867496, -0.016330564, 0.010033096, 0.000583983, 0.024295557, 0.008137335, 0.044343118, 0.0117472, 0.0038171413, 0.016703196, -0.017942196, -0.017159669, -0.012408621, 0.028059134, 0.03957344, -0.025897872, -0.033294603, 0.015240618, -0.0052587586, 0.009697729, -0.027984608, 0.0012133805, 0.0029204974, -0.0037309704, 0.011598147, 0.007857862, 0.01406683, 0.017168986, 0.007909099, 0.01616288, -0.058205, -0.0043248516, 0.0131166205, 0.012380674, -0.0006410422, 0.008039519, 0.00929715, 0.0031533919, 0.0012704397, 0.0021239982, 0.012566989, -0.011933516, -0.0036401416, -0.008533256, -0.0004296904, -0.019227773, 0.0033513524, 0.028785765, -0.03458018, 0.0073920726, 0.031021552, 0.035977546, -0.017457774, -0.021128193, -0.015138145, -0.010284622, -0.00042677924, -0.050491534, -0.014336987, -0.018845826, 0.0030136553, 0.0029554316, 0.014467408, 0.020047562, -0.01674046, 0.004054694, 0.0093716765, -0.0038520757, 0.0025269056, -0.011486358, 0.017373933, -0.0012133805, -0.015007724, 0.015585302, -0.008561203, -0.0011114891, 0.011775147, 0.023326717, -0.0020483073, -0.0173553, 0.0040267464, 0.020792823, -0.013982988, -0.022115665, 0.0062834946, -0.01967493, 0.00014206566, -0.018473195, 0.009059598, -0.011132359, 0.0182403, -0.0022288007, 0.011961463, 0.017234195, -0.012054621, 0.0031347603, 0.01766272, 0.008714913, 0.022097033, 0.0062415735, -0.032120813, -0.027500186, 0.01329362, 0.0067818887, -0.005705916, -0.012231621, -0.010023781, 0.011150991, -0.008654361, 0.023997452, -0.00091119984, 0.033667233, -0.019581772, -0.023382612, 0.035865758, -0.0012075582, -0.0069262832, -0.0082304925, 0.0067120204, 0.004683509, 0.0054730214, 0.01878993, -0.03053713, -0.015846144, -0.0012075582, 0.016209459, 0.041660175, 0.0047184434, -0.0069309413, 0.0048721535, -0.009464834, 0.023978822, -0.0030136553, -0.0069682044, -0.009632518, -0.038120177, -0.025786083, -0.0016244394, 0.005146969, -0.022693243, 0.0041618254, -0.003283813, -0.0039405753, -0.0019237088, 0.005743179, -0.0028855633, 0.016488932, -0.023047242, -0.016414408, 0.014132041, 0.0178863, 0.032269865, -0.021482192, -0.012436568, -0.014840039, 0.01550146, -0.01967493, 0.0017653406, -0.028767133, -0.006358021, -0.0058037317, -0.006311442, -0.0007231375, 0.0068144943, -0.01801672, 0.012026674, -0.016954722, -0.0052261534, 0.0182403, -0.0059807315, -0.004355128, 0.008621756, 0.007657572, 0.01031257, -0.0081140455, 0.0074339933, -0.011123043, -0.020718297, -0.0231404, 0.004091957, -0.01817509, 0.011644727, -0.018715404, 0.008826703, 0.0101262545, -0.020215245, 0.00085879856, -0.013424041, 0.05973279, 0.0026782872, 0.0171783, -0.037263125, -0.0027924054, 0.025189873, 0.015585302, 0.0138525665, 0.016013829, -0.028767133, 0.019581772, -0.011150991, -0.033182815, -0.011961463, 0.0153617235, -0.01132799, -0.004045378, -0.022301981, -0.030574394, -0.01865951, 0.026084188, -0.010657254, -0.0043970486, 0.013666252, 0.06342184, 0.016833616, 0.00965115, -0.024724083, 0.022562822, -0.0245564, 0.00069810136, -0.0010590879, -0.016777722, -0.024016084, -0.0024430635, -0.009208649, 0.019283667, -0.006311442, 0.018892404, -0.03528818, -0.01377804, 0.0019027484, 0.00077961443, 0.0059621, 0.020941876, -0.019022826, -0.003663431, -0.020010298, 0.01783972, -0.020606508, 0.037430808, -0.0012378345, -0.018165773, 0.005622074, 0.013097988, 0.0021961955, -0.0028878923, 0.001182522, 0.0062508895, -0.019469984, 0.035232283, 0.025208505, -0.013722146, -0.022842295, -0.008328308, -0.00019999818, 0.03853007, 0.016377144, 0.0014555908, 0.005836337, -0.010526833, 0.02194798, -0.019050773, -0.006222942, -0.0030788658, 0.024947662, 0.020308403, -0.0016535512, 0.0234944, -0.02479861, 0.027220713, 0.017522985, 0.013899146, -0.019022826, 0.040467754, -0.020196615, 0.01371283, -0.018883089, 0.012902357, 0.013396094, -0.030611657, 0.008146651, 0.022972716, 0.026866714, 0.0053798635, 0.004520483, -0.03912628, 0.00013602496, 0.022749137, -0.013787356, 0.01079699, -0.007024099, -0.004683509, -0.022078402, -0.011067148, -0.0048768115, -0.017495038, -0.021090928, -0.003067221, -0.0037775494, -0.024500504, -0.00971636, -0.008659019, -0.0051702587, 0.012976883, -0.007890467, 0.0082304925, -7.89658e-05, -0.02205977, 0.0069728624, 0.0034724574, 0.0011865976, 0.032698393, 0.05663995, -0.030947026, 0.0062695206, 0.017327353, -0.0010020287, -0.007466599, 0.0048814695, 0.021016402, -0.0053146533, 0.034524284, -0.010275307, 0.044268593, -0.0037402862, -0.0075783883, 0.022730507, -0.012846462, 0.022171559, 0.020681035, 0.0034608128, -0.014923882, 0.014392883, -0.021444928, 0.0071824673, 0.015287197, 0.010769043, -0.004730088, 0.025543872, 0.03826923, -0.005030522, 0.005845653, 0.011719253, -0.013023462, -0.016470302, -0.0018596628, -0.0055661793, -0.023289453, -0.013125936, -0.014989092, 0.0032581945, -0.0014218211, -0.023438506, 0.0021927021, 0.0054357583, -0.01883651, 0.00938565, -0.012054621, 0.023419874, 0.0031533919, 0.015054302, -0.0126135675, -0.044305857, -0.03301513, 0.00021688304, -0.008845334, 0.011579516, -0.020830087, 0.010079675, 0.016964037, 0.0033583392, 0.009939939, -0.020997772, 0.014290408, -0.018324142, -0.020215245, 0.014225198, 0.018361405, -0.012893042, -0.014318356, -0.012166411, -0.003234905, 7.0341426e-05, 0.018752668, 0.0031743525, -0.0006561804, 0.006288152, 0.028282711, 0.009017676, -0.006358021, 0.016591407, 0.04188375, 0.013023462, 0.016479617, -0.015035671, 0.013153884, 0.014681672, 0.010247359, 0.033443656, 0.026195977, 0.00936236, -0.01883651, -0.008062809, 0.0036820625, 0.0013589396, 0.00022925556, 0.0066281785, 0.013638304, -0.0059947055, -0.050864168, 0.022581454, 0.017392565]
    response = load_vectors.call(search_vector, top_k=100)
    filtered_vectors = filter_vectors.call(response["matches"])

    with open("test-dataset.json", "w") as f:
        json.dump(filtered_vectors, f)
    return filtered_vectors

pinecone_image = modal.Image.debian_slim().pip_install("pandas")
@stub.local_entrypoint()
def test_cluster_vectors():
    import pandas as pd
    data = pd.read_json("/Users/finnmacken/Desktop/TerrariumV2/machine-learning-pipeline/test-dataset.json")
    labels = kmeans_classify.call(data, n_clusters=20)

    return labels

@stub.local_entrypoint()
def test_database_write():
    write_vectors.call()
    return None
